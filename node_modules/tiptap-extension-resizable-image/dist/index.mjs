import { useRef } from 'react';
import { jsxs, jsx, Fragment } from 'react/jsx-runtime';
import { ReactNodeViewRenderer, NodeViewWrapper } from '@tiptap/react';
import { Node, mergeAttributes, nodeInputRule } from '@tiptap/core';
import { Plugin, PluginKey } from '@tiptap/pm/state';

var F=Object.defineProperty,K=Object.defineProperties;var O=Object.getOwnPropertyDescriptors;var k=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var S=(e,o,r)=>o in e?F(e,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[o]=r,w=(e,o)=>{for(var r in o||(o={}))B.call(o,r)&&S(e,r,o[r]);if(k)for(var r of k(o))U.call(o,r)&&S(e,r,o[r]);return e},L=(e,o)=>K(e,O(o));var q=e=>{let{updateAttributes:o,node:{attrs:r},editor:m,extension:h}=e,{captionProps:c}=h.options,u=useRef(null),d=f=>{if(!u.current)return;let{innerText:p,innerHTML:R}=f.target,y=(p==null?void 0:p.replaceAll(`
`,""))==="",x=R.replaceAll("<div>",`
`).replaceAll("</div>","").replaceAll("<br>",""),v=y?"":x;u.current.innerHTML=v,o({caption:v});},b=f=>{f.preventDefault();let p=f.clipboardData.getData("text/plain"),R=window.getSelection();if(R&&p){let y=R.getRangeAt(0);R.deleteFromDocument(),y.insertNode(document.createTextNode(p)),y.setStart(y.endContainer,y.endOffset);}},g=f=>{if((f.ctrlKey||f.metaKey)&&f.key==="a"){f.preventDefault();let p=window.getSelection();if(p){let R=p.getRangeAt(0);R.selectNodeContents(f.currentTarget),p.addRange(R);}}};return jsx("span",L(w({},c),{ref:u,className:`caption ${(c==null?void 0:c.className)||""}`,contentEditable:m.isEditable,onBlur:d,onPaste:b,onKeyDown:g,dangerouslySetInnerHTML:{__html:r.caption||""}}))},C=q;function E(e,o,r){return Math.min(Math.max(e,o),r)}var n={east:1,north:8,south:2,west:4};function N({editor:e,imageRef:o,minWidth:r,maxWidth:m,minHeight:h,maxHeight:c,keepRatio:u,onResizeEnd:d,onResizeStart:b}){let g=useRef(null),f=useRef({currentHeight:0,currentWidth:0,direction:0,isResizing:!1,ratio:0,startHeight:0,startWidth:0,startX:0,startY:0}),p=e.view.dom,R=t=>{let l=t===n.east||t===n.west,i=t===n.north||t===n.south,M=t&n.north&&t&n.west||t&n.south&&t&n.east,H=l?"ew":i?"ns":M?"nwse":"nesw";p!==null&&p.style.setProperty("cursor",`${H}-resize`,"important"),document.body!==null&&(document.body.style.setProperty("cursor",`${H}-resize`,"important"),document.body.style.setProperty("-webkit-user-select","none","important"));},y=()=>{p!==null&&p.style.removeProperty("cursor"),document.body!==null&&(document.body.style.removeProperty("cursor"),document.body.style.removeProperty("-webkit-user-select"));},x=(t,l)=>{if(!e.isEditable)return;let i=o.current,M=g.current;if(i!==null&&M!==null){t.preventDefault();let{width:H,height:a}=i.getBoundingClientRect(),s=f.current;s.startWidth=H,s.startHeight=a,s.ratio=H/a,s.currentWidth=H,s.currentHeight=a,s.startX=t.clientX,s.startY=t.clientY,s.isResizing=!0,s.direction=l,R(l),b==null||b(),M.classList.add("image-control-wrapper--resizing"),i.style.height=`${a}px`,i.style.width=`${H}px`,document.addEventListener("pointermove",v),document.addEventListener("pointerup",I);}},v=t=>{let l=o.current,i=f.current,M=i.direction&(n.east|n.west),H=i.direction&(n.south|n.north);if(!(l===null||!i.isResizing)){if(u){let a=0,s=0;if(M){let z=Math.floor(i.startX-t.clientX);z=i.direction&n.east?-z:z,a=E(i.startWidth+z,r,m),s=a/i.ratio;}else {let z=Math.floor(i.startY-t.clientY);z=i.direction&n.south?-z:z,s=E(i.startHeight+z,h,c),a=s*i.ratio;}if(a<r||a>m||s<h||s>c)return;l.style.width=`${a}px`,l.style.height=`${s}px`,l.style.maxWidth=`${a}px`,i.currentHeight=s,i.currentWidth=a;return}if(M&&H){let a=Math.floor(i.startX-t.clientX);a=i.direction&n.east?-a:a;let s=Math.floor(i.startY-t.clientY);s=i.direction&n.south?-s:s;let z=E(i.startWidth+a,r,m),A=E(i.startHeight+s,h,c);l.style.width=`${z}px`,l.style.height=`${A}px`,l.style.maxWidth=`${z}px`,i.currentHeight=A,i.currentWidth=z;}else if(H){let a=Math.floor(i.startY-t.clientY);a=i.direction&n.south?-a:a;let s=E(i.startHeight+a,h,c);l.style.height=`${s}px`,i.currentHeight=s;}else {let a=Math.floor(i.startX-t.clientX);a=i.direction&n.east?-a:a;let s=E(i.startWidth+a,r,m);l.style.width=`${s}px`,l.style.maxWidth=`${s}px`,i.currentWidth=s;}}},I=()=>{let t=o.current,l=f.current,i=g.current;if(t!==null&&i!==null&&l.isResizing){let M=l.currentWidth,H=l.currentHeight;l.startWidth=0,l.startHeight=0,l.ratio=0,l.startX=0,l.startY=0,l.currentWidth=0,l.currentHeight=0,l.isResizing=!1,i.classList.remove("image-control-wrapper--resizing"),y(),d(M,H),document.removeEventListener("pointermove",v),document.removeEventListener("pointerup",I);}};return jsxs("div",{ref:g,children:[jsx("div",{className:"image-resizer image-resizer-n",onPointerDown:t=>{x(t,n.north);}}),jsx("div",{className:"image-resizer image-resizer-ne",onPointerDown:t=>{x(t,n.north|n.east);}}),jsx("div",{className:"image-resizer image-resizer-e",onPointerDown:t=>{x(t,n.east);}}),jsx("div",{className:"image-resizer image-resizer-se",onPointerDown:t=>{x(t,n.south|n.east);}}),jsx("div",{className:"image-resizer image-resizer-s",onPointerDown:t=>{x(t,n.south);}}),jsx("div",{className:"image-resizer image-resizer-sw",onPointerDown:t=>{x(t,n.south|n.west);}}),jsx("div",{className:"image-resizer image-resizer-w",onPointerDown:t=>{x(t,n.west);}}),jsx("div",{className:"image-resizer image-resizer-nw",onPointerDown:t=>{x(t,n.north|n.west);}})]})}var Q=e=>{let{updateAttributes:o,node:r,extension:m,editor:h}=e,c=useRef(null),u=r.attrs,d=m.options,b=!h.isEditable,{width:g,height:f}=u,p=u["data-keep-ratio"],R=!p&&{width:g,height:f},y=L(w({},u),{style:L(w({},R||{}),{maxWidth:g})}),x=(I,t)=>{p&&c.current&&(c.current.style.width="",c.current.style.height=""),o({width:I,height:t});},v=I=>{var t;(t=d.onContextMenu)==null||t.call(d,I,e);};return b?jsxs(Fragment,{children:[jsx("img",w({},y)),d.withCaption&&u.caption&&jsx(C,w({},e))]}):jsxs(Fragment,{children:[jsx("img",L(w({},y),{ref:c,onContextMenu:v})),d.withCaption&&jsx(C,w({},e)),jsx(N,{editor:h,imageRef:c,minWidth:d.minWidth,maxWidth:d.maxWidth,minHeight:d.minHeight,maxHeight:d.maxHeight,keepRatio:p,onResizeEnd:x})]})},D=Q;var ee=e=>jsx(NodeViewWrapper,{className:"image-component","data-drag-handle":!0,children:jsx(D,w({},e))}),W=ee;var ae=/(?:^|\s)(!\[(.+|:?)]\((\S+)(?:(?:\s+)["'](\S+)["'])?\))$/,le=Node.create({name:"imageComponent",group:"inline",inline:!0,draggable:!0,atom:!0,addOptions(){return {HTMLAttributes:{},defaultHeight:500,defaultWidth:500,minWidth:100,maxWidth:16384,minHeight:100,maxHeight:1/0,allowBase64:!0}},addAttributes(){return {src:{default:""},alt:{default:""},title:{default:""},width:{default:this.options.defaultWidth},height:{default:this.options.defaultHeight},"data-keep-ratio":{parseHTML:e=>e.getAttribute("data-keep-ratio")!=="false",renderHTML(e){return e["data-keep-ratio"]?{style:[`max-width: ${e.width}px`].join(";"),"data-keep-ratio":"true"}:{}},default:!0},className:{parseHTML:e=>e.getAttribute("class"),renderHTML:e=>({class:e.className}),default:""},caption:{parseHTML:e=>{var o,r;return (r=(o=e.parentElement)==null?void 0:o.querySelector("span"))==null?void 0:r.textContent},renderHTML(){return null},default:""}}},parseHTML(){return [{tag:this.options.allowBase64?"img[src]":'img[src]:not([src^="data:"])'},{tag:"span > img + span",ignore:!0}]},renderHTML({HTMLAttributes:e,node:o}){var d,b;let r=document.createElement("span");r.classList.add("node-imageComponent");let m=document.createElement("span");m.classList.add("image-component");let h=document.createElement("img"),c=mergeAttributes(this.options.HTMLAttributes,e);Object.keys(c).forEach(g=>{g!=="caption"&&h.setAttribute(g,c[g]);}),m.appendChild(h);let u=o.attrs;if(u.caption){let g=document.createElement("span");g.classList.add("caption",...((b=(d=this.options.captionProps)==null?void 0:d.className)==null?void 0:b.split(" "))||""),g.innerHTML=u.caption,m.appendChild(g);}return r.appendChild(m),r},addCommands(){return {setResizableImage:(e,o,r)=>({commands:m})=>m.insertContentAt(o||this.editor.state.selection.head,{type:this.name,attrs:e},r)}},addInputRules(){return [nodeInputRule({find:ae,type:this.type,getAttributes:e=>{let[,,o,r,m]=e;return {src:r,alt:o,title:m}}})]},addProseMirrorPlugins(){return [new Plugin({key:new PluginKey(this.name),props:{handlePaste:(e,o,r)=>{var u,d,b;let m=(u=o.clipboardData)==null?void 0:u.files;if(((d=r.content.firstChild)==null?void 0:d.type.name)===this.name)return this.editor.commands.setResizableImage(w({},r.content.firstChild.attrs)),!0;let h=!((b=o.clipboardData)!=null&&b.getData("text/html"));if(!m||m.length===0||!this.options.onUpload||!h)return !1;let c=this.editor.state.selection.head;for(let g of m)this.options.onUpload(g).then(f=>{this.editor.chain().focus().setResizableImage(f,c,{updateSelection:!1}).run();});return !0},handleDrop:(e,o)=>{var c,u;o.preventDefault();let r=(c=o.dataTransfer)==null?void 0:c.files,m=!((u=o.dataTransfer)!=null&&u.getData("text/html"));if(!r||r.length===0||!this.options.onUpload||!m)return !1;let h=this.editor.state.selection.head;for(let d of r)this.options.onUpload(d).then(b=>{this.editor.chain().focus().setResizableImage(b,h,{updateSelection:!1}).run();});}}})]},addNodeView(){return ReactNodeViewRenderer(e=>W(e))}});

export { C as CaptionInput, N as ImageResizer, le as ResizableImage, D as ResizableImageComponent, W as ResizableImageNodeView };
